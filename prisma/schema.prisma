generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Tenant {
  id            String      @id @default(cuid())
  name          String
  createdAt     DateTime    @default(now())
  whopCompanyId String?     @unique
  challenges    Challenge[]
  users         User[]
}

model User {
  id                 String                 @id @default(cuid())
  email              String                 @unique
  name               String?
  role               Role                   @default(USER)
  createdAt          DateTime               @default(now())
  tenantId           String
  whopUserId         String?                @unique
  whopAffiliateLink  String?
  whopCompanyId      String?
  isFreeTier         Boolean                @default(true)
  membershipId       String?
  subscriptionStatus String                 @default("free")
  tier               String                 @default("free")
  activePromoCode    String?                // Active promo code for tier upgrade
  createdChallenges  Challenge[]            @relation("Creator")
  winnings           ChallengeWinner[]      @relation("Winners")
  enrollments        Enrollment[]
  notifications      InternalNotification[] @relation("UserNotifications")
  conversions        OfferConversion[]      @relation("UserConversions")
  revenueShares      RevenueShare[]         @relation("CreatorRevenue")
  tenant             Tenant                 @relation(fields: [tenantId], references: [id])
  whopProducts       WhopProduct[]          @relation("CreatorProducts")

  @@index([whopCompanyId])
  @@index([tenantId])
}

model Challenge {
  id                 String                 @id @default(cuid())
  tenantId           String
  experienceId       String
  title              String
  description        String?
  startAt            DateTime
  endAt              DateTime
  status             String                 @default("ACTIVE")
  companyId          String?
  requiredProofTypes Json?
  proofType          ProofType              @default(NONE)
  cadence            Cadence                @default(DAILY)
  rules              Json?
  imageUrl           String?
  imageUrlThumbnail  String?                // Optimized thumbnail for list views (WebP, 400x225, 75% quality)
  createdAt          DateTime               @default(now())
  creatorId          String?
  whopCreatorId      String?
  whopCategoryId     String?
  whopCategoryName   String?
  whopTags           Json?
  monetizationRules  Json?
  targetAudience     Json?
  marketingTags      Json?
  difficulty         String?                @default("BEGINNER")
  isPublic           Boolean                @default(true)
  featured           Boolean                @default(false)
  whopCompanyId      String?
  creator            User?                  @relation("Creator", fields: [creatorId], references: [id])
  tenant             Tenant                 @relation(fields: [tenantId], references: [id])
  challengeOffers    ChallengeOffer[]
  winners            ChallengeWinner[]
  enrollments        Enrollment[]
  notifications      InternalNotification[] @relation("ChallengeNotifications")
  conversions        OfferConversion[]      @relation("ChallengeConversions")
  revenueShares      RevenueShare[]

  @@index([experienceId])
  @@index([whopCompanyId])
  @@index([tenantId])
  @@index([isPublic, featured, createdAt]) // Composite index for discover page queries
  @@index([status, endAt]) // Index for active/ended challenge queries
  @@index([createdAt]) // Index for ordering by creation date
}

model WhopProduct {
  id              String           @id @default(cuid())
  whopProductId   String           @unique
  name            String
  description     String?
  price           Float
  currency        String           @default("USD")
  productType     String
  imageUrl        String?
  checkoutUrl     String
  isActive        Boolean          @default(true)
  creatorId       String
  whopCreatorId   String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  challengeOffers ChallengeOffer[]
  creator         User             @relation("CreatorProducts", fields: [creatorId], references: [id])

  @@index([creatorId])
  @@index([whopCreatorId])
}

model ChallengeOffer {
  id                 String            @id @default(cuid())
  challengeId        String
  whopProductId      String
  offerType          String
  discountPercentage Int?
  discountAmount     Float?
  originalPrice      Float
  discountedPrice    Float
  timeLimit          Int?
  triggerConditions  String?
  customMessage      String?
  isActive           Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  challenge          Challenge         @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  whopProduct        WhopProduct       @relation(fields: [whopProductId], references: [id])
  conversions        OfferConversion[]

  @@index([challengeId])
}

model OfferConversion {
  id               String         @id @default(cuid())
  challengeOfferId String
  userId           String
  challengeId      String
  conversionType   String
  whopCheckoutUrl  String?
  revenue          Float?
  metadata         String?
  createdAt        DateTime       @default(now())
  challenge        Challenge      @relation("ChallengeConversions", fields: [challengeId], references: [id])
  challengeOffer   ChallengeOffer @relation(fields: [challengeOfferId], references: [id], onDelete: Cascade)
  user             User           @relation("UserConversions", fields: [userId], references: [id])

  @@index([challengeId])
  @@index([userId])
}

model Enrollment {
  id           String    @id @default(cuid())
  experienceId String
  challengeId  String
  userId       String
  joinedAt     DateTime  @default(now())
  checkins     Checkin[]
  challenge    Challenge @relation(fields: [challengeId], references: [id])
  user         User      @relation(fields: [userId], references: [id])
  proofs       Proof[]

  @@unique([challengeId, userId])
  @@index([experienceId])
  @@index([challengeId]) // Index for faster enrollment lookups per challenge
  @@index([userId]) // Index for faster user enrollment queries
  @@index([joinedAt]) // Index for ordering enrollments by date
}

model Proof {
  id           String     @id @default(cuid())
  experienceId String
  enrollmentId String
  type         ProofType
  url          String?
  text         String?
  version      Int        @default(1)
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([enrollmentId, isActive])
  @@index([experienceId])
  @@index([createdAt]) // Index for ordering proofs by date
  @@index([type]) // Index for filtering by proof type
}

model Checkin {
  id           String     @id @default(cuid())
  enrollmentId String
  createdAt    DateTime   @default(now())
  text         String?
  imageUrl     String?
  linkUrl      String?
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
}

model ChallengeWinner {
  id          String    @id @default(cuid())
  challengeId String
  userId      String
  place       Int
  selectedAt  DateTime  @default(now())
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user        User      @relation("Winners", fields: [userId], references: [id])

  @@unique([challengeId, place])
  @@unique([challengeId, userId])
  @@index([challengeId])
}

model InternalNotification {
  id          String     @id @default(cuid())
  userId      String
  challengeId String?
  title       String
  message     String
  type        String     @default("general")
  metadata    String?
  isRead      Boolean    @default(false)
  readAt      DateTime?
  createdAt   DateTime   @default(now())
  challenge   Challenge? @relation("ChallengeNotifications", fields: [challengeId], references: [id], onDelete: Cascade)
  user        User       @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([challengeId])
  @@index([createdAt])
}

enum Cadence {
  DAILY
  END_OF_CHALLENGE
}

enum Role {
  USER
  ADMIN
}

enum ProofType {
  NONE
  TEXT
  PHOTO
  LINK
}

model RevenueShare {
  id           String   @id @default(cuid())
  challengeId  String
  creatorId    String
  whopCreatorId String
  paymentId    String   // Original Whop payment ID
  amount       Int      // Creator amount in cents
  platformFee  Int      // Platform fee in cents
  transferId   String?  // Whop transfer ID from payUser
  status       String   @default("pending") // pending, completed, failed, retry
  createdAt    DateTime @default(now())
  processedAt  DateTime?
  errorMessage String?
  retryCount   Int      @default(0)
  
  // Relations
  challenge    Challenge @relation(fields: [challengeId], references: [id])
  creator      User      @relation("CreatorRevenue", fields: [creatorId], references: [id])
  
  @@index([challengeId])
  @@index([creatorId])
  @@index([paymentId])
  @@index([status])
  @@map("RevenueShare")
}

model PromoCode {
  id          String    @id @default(cuid())
  code        String    @unique // BETA-XK9P-2M4L format
  tier        String    @default("ProPlus") // Which tier this code grants
  usedBy      String?   // User ID who claimed this code
  usedAt      DateTime? // When the code was claimed
  isActive    Boolean   @default(true) // Can be deactivated by admin
  validUntil  DateTime? // Optional expiration date
  createdAt   DateTime  @default(now())
  
  @@index([code])
  @@index([usedBy])
  @@map("PromoCode")
}
